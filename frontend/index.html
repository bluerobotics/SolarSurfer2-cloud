<html>
<meta http-equiv="refresh" content="600">
<head>
    <title>A Leaflet map!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.8.0/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.8.0/leaflet.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <script>
        //From: https://github.com/bbecquet/Leaflet.RotatedMarker/blob/master/leaflet.rotatedMarker.js
        (function () {
            // save these original methods before they are overwritten
            var proto_initIcon = L.Marker.prototype._initIcon;
            var proto_setPos = L.Marker.prototype._setPos;

            var oldIE = (L.DomUtil.TRANSFORM === 'msTransform');

            L.Marker.addInitHook(function () {
                var iconOptions = this.options.icon && this.options.icon.options;
                var iconAnchor = iconOptions && this.options.icon.options.iconAnchor;
                if (iconAnchor) {
                    iconAnchor = (iconAnchor[0] + 'px ' + iconAnchor[1] + 'px');
                }
                this.options.rotationOrigin = this.options.rotationOrigin || iconAnchor || 'center bottom';
                this.options.rotationAngle = this.options.rotationAngle || 0;

                // Ensure marker keeps rotated during dragging
                this.on('drag', function (e) { e.target._applyRotation(); });
            });

            L.Marker.include({
                _initIcon: function () {
                    proto_initIcon.call(this);
                },

                _setPos: function (pos) {
                    proto_setPos.call(this, pos);
                    this._applyRotation();
                },

                _applyRotation: function () {
                    if (this.options.rotationAngle) {
                        this._icon.style[L.DomUtil.TRANSFORM + 'Origin'] = this.options.rotationOrigin;

                        if (oldIE) {
                            // for IE 9, use the 2D rotation
                            this._icon.style[L.DomUtil.TRANSFORM] = 'rotate(' + this.options.rotationAngle + 'deg)';
                        } else {
                            // for modern browsers, prefer the 3D accelerated version
                            this._icon.style[L.DomUtil.TRANSFORM] += ' rotateZ(' + this.options.rotationAngle + 'deg)';
                        }
                    }
                },

                setRotationAngle: function (angle) {
                    this.options.rotationAngle = angle;
                    this.update();
                    return this;
                },

                setRotationOrigin: function (origin) {
                    this.options.rotationOrigin = origin;
                    this.update();
                    return this;
                }
            });
        })();

        fetch("/payloads?skip=0&limit=100000")
            .then(res => res.json())
            .then(data => {

                for (let point of data) {
                    point["heading"] = (point["heading"] * 360 / 255),
                        point["solar_panel_voltage"] = point["solar_panel_voltage"] * 64 / 255,
                        point["battery_current"] = point["battery_current"] * 64 / 255
                    point["battery_voltage"] = point["battery_voltage"] * 20 / 255
                    point["left_motor_pwm"] = (point["left_motor_pwm"] - 127) * 100 / 127
                    point["right_motor_pwm"] = (point["right_motor_pwm"] - 127) * 100 / 127
                }
                const last = data[data.length - 1]
                var map = L.map('map').setView([last["gps_lat"], last["gps_lon"]], 13);

                L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                }).addTo(map);

                const svgIcon = L.divIcon({
                    html: `
            <svg style="width:24px;height:24px" viewBox="0 0 24 24">
                <path fill="blue" d="M15,20H9V12H4.16L12,4.16L19.84,12H15V20Z" />
            </svg>`,
                    className: "",
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                });

                L.polyline(data.map(point => [point["gps_lat"], point["gps_lon"]])).addTo(map)

                for (const point of data) {
                    let marker = L.marker([point["gps_lat"], point["gps_lon"]], {
                        title: JSON.stringify(point, null, 2),
                        rotationAngle: point["heading"],
                        icon: svgIcon,
                    })

                    map.on('mouseover', function (ev) {
                        ev?.layer?.openPopup()
                    })

                    marker.addTo(map);
                }
            })

    </script>
</body>

</html>

